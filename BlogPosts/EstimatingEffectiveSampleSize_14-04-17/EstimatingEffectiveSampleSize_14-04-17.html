
<html>

    <head>
        <title>Joseph Crispell | Blog - ESS</title>
        <link href="../../default.css" rel="stylesheet" type="text/css">
    </head>

    <body>
        
        <!-- Insert Sidebar box -->
        <div id="sidebar" style="top: 43.5%">
            
            <pageLink><a href="index.html">Home</a></pageLink>
            <pageLink><a href="Blog.html">Blog</a></pageLink>
            <pageLink><a href="About.html">About</a></pageLink>
            <pageLink><a href="Outputs.html">Outputs</a></pageLink>
        </div>
        
        <!-- Insert Title -->
        <div id="title">
            <img src="BlogThumbnail.png" width="40%">
                
        </div>
        
        <!-- Insert Text Body -->
        <div id="mainText">
            
            <br><br><br>
            
            <h1>How is the Effective Sample Size calculated?</h1>
            
            <p>

                For a particular model, the posterior distribution represents the likelihood of every possible
                parameter combination. A parameter sets likelihood is calculated by comparing the model to data.
                The posterior distribution is searched to find a set of parameters such that the model best
                represents the data.<br><br>
                
                The sample from a posterior distribution should be a reflection of the likelihood of each
                parameter value. Therefore, the amount of times a particular value for a parameter was sampled
                from the posterior space should provide some indication of how appropriate that value is.<br><br>
                
                The Effective Sample Size (ESS) is a metric that is commonly used to assess the progress of an
                evolutionary analysis conducted in <a href="http://beast.bio.ed.ac.uk/">BEAST</a>. It is defined
                as the number of independent samples that the posterior sample is equivalent to.<br><br>
                
                I spent a wee bit of time trying to work out how the ESS was calculated in BEAST. In the end, I
                found a formal definition online that provides a similar (especially at low values of ESS) to
                those produced by BEAST.<br><br>
                
                The ESS is estimated as follows (taken from
                <a href="http://www.itl.nist.gov/div898/handbook/eda/section3/autocopl.html">here</a>):
            </p>
            
            <img src="/BlogPosts/EstimatingEffectiveSampleSize_14-04-17/EffectiveSampleSizeEquation.png">
            
            <p>
                The ESS captures the independence of posterior samples. Since the shape of the posterior is often
                uneven - some parameter values are more likely than others, the steps within the sampling chain
                aren't necessarily independent. The ESS attempts to estimate how often a parameter value was
                encountered independently by estimating the number of steps necessary on the sampling chain after
                which two samples can be considered independent. This is captured in the Auto-Correlation Time
                (ACT).<br><br>
                
                The Auto-Correlation Time (ACT) is defined as the number of steps in an MCMC chain that two
                samples have to be separated by for thm to be considered uncorrelated.<br><br>
                
                The ACT is estimated as follows(taken from
                <a href="http://people.duke.edu/~ccc14/sta-663-2016/16C_PyMC3.html">here</a>):
            </p>
            
            <img src="/BlogPosts/EstimatingEffectiveSampleSize_14-04-17/AutoCorrelationTimeEquation.png">
            
            <p>
                I used the following R code to estimate the ESS value of a parameter from its posterior sample:
            </p>
            
            <div id="codeBlock">
                # Calculate the mean of the sample<br>
                sampleMean &lt;- mean(posteriorSample)<br>
                nSamples &lt;- length(posteriorSample)<br><br>
                    
                # Create an array to store the correlation values between a[index] vs. a[index + lag]<br>
                autoCorrelationValues &lt;- c()<br><br>
                
                # Calculate the auto-correlate values for each lag distance<br>
                for(lag in 1:(nSamples - 1)){<br><br>
                    
                &emsp;# Calculate the auto-correlation value for the current lag period<br>
                &emsp;a &lt;- posteriorSample[1:(nSamples - lag)] - sampleMean<br>
                &emsp;b &lt;- posteriorSample[(1:(nSamples - lag) + lag)] - sampleMean<br><br>
                    
                &emsp;Ch &lt;- (1/nSamples) * sum(a * b)<br>
                &emsp;C0 &lt;- sum((posteriorSample - sampleMean)^2) / nSamples<br>
                &emsp;autoCorrelationValues[lag] &lt;- Ch / C0<br><br>
                    
                &emsp;# Check if auto-correlation has dropped below zero<br>
                &emsp;if(lag != 1 &amp;&amp;<br>
                &emsp;&emsp;(autoCorrelationValues[lag - 1] &gt; 0 &amp;&amp; autoCorrelationValues[lag] &lt;= 0 ||<br>
                &emsp;&emsp;autoCorrelationValues[lag - 1] &lt; 0 &amp;&amp; autoCorrelationValues[lag] &gt;= 0)){<br>
                &emsp;&emsp;break;<br>
                &emsp;}<br>
 
                }<br><br>
                    
                # Calculate the Effective Sample Size<br>
                ess &lt;- nSamples / (1 + 2 * (sum(autoCorrelationValues)))<br>
                
            </div>
            
        </div>
    </body>
</html>
